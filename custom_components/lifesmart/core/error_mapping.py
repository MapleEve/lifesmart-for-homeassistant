"""LifeSmart API错误码映射和用户友好错误处理模块。

此模块提供LifeSmart API错误码到中文描述、解决方案建议
和逻辑分类的映射功能，用于改善用户体验和故障排查。
这有助于在日志中提供更清晰的错误信息，并指导用户解决问题。

由 @MapleEve 创建，作为集成架构重构的一部分。
"""

from typing import Tuple, Optional

# 错误码 -> (中文描述, 解决方案建议, 逻辑分类)
ERROR_CODE_MAPPING = {
    # --- 请求与认证 (Request & Auth) ---
    10001: (
        "请求格式错误",
        "请校验发送的JSON数据结构及字段类型是否符合API文档。",
        "数据校验",
    ),
    10002: ("AppKey不存在", "请在集成配置中检查您的AppKey是否正确填写。", "配置问题"),
    10003: (
        "不支持HTTP GET请求",
        "这是一个开发错误，该接口应使用POST方法。",
        "方法调用",
    ),
    10004: ("签名非法", "请检查签名算法、时间戳或凭据是否正确。", "安全策略"),
    10005: (
        "用户没有授权",
        "请检查用户令牌(UserToken)是否正确，或到LifeSmart平台检查授权。",
        "用户授权",
    ),
    10006: (
        "用户授权已经过期",
        "用户令牌(UserToken)已失效，请在选项中重新进行认证以获取新令牌。",
        "用户授权",
    ),
    10007: (
        "非法访问",
        "您的IP地址可能不在白名单中，请检查LifeSmart平台的安全设置。",
        "安全策略",
    ),
    10010: ("Method非法", "调用的API方法名称不存在或已被弃用。", "方法调用"),
    10012: ("用户名已存在", "此用户名已被注册，请更换用户名。", "配置问题"),
    10015: (
        "权限不够",
        "当前账户权限不足以执行此操作，请联系管理员提升权限。",
        "权限管理",
    ),
    10018: (
        "GPS位置非法访问拒绝",
        "请检查应用的地理位置权限或相关场景的地理围栏设置。",
        "安全策略",
    ),
    10022: (
        "请求地址需要重定向",
        "API服务器地址可能已变更，请尝试更新集成。",
        "服务端错误",
    ),
    # --- 服务器与网络 (Server & Network) ---
    10008: (
        "内部错误",
        "LifeSmart服务器内部发生未知错误，请稍后重试或联系技术支持。",
        "服务端错误",
    ),
    10011: (
        "操作超时",
        "网络连接不稳定或LifeSmart服务器响应超时，请检查您的网络连接。",
        "网络问题",
    ),
    # --- 设备与资源 (Device & Resource) ---
    10009: (
        "设置属性失败",
        "检查设备是否在线且支持该属性设置，或查看日志获取详细信息。",
        "设备操作",
    ),
    10013: (
        "设备没准备好",
        "设备当前可能离线或正忙，请确保设备在线后重试。",
        "设备操作",
    ),
    10014: (
        "设备已经被其他账户注册",
        "请先从原账户中解绑该设备，然后再尝试添加。",
        "设备管理",
    ),
    10016: (
        "设备不支持该操作",
        "您尝试的操作不被此设备型号支持，请查阅设备文档。",
        "设备操作",
    ),
    10017: ("数据非法", "提交给设备的参数值或格式不正确，请检查。", "数据校验"),
    10019: (
        "请求对象不存在",
        "请求中的设备ID、场景ID等不存在，请检查配置或设备是否已被删除。",
        "资源定位",
    ),
    10020: ("设备已经存在账户中", "此设备已在您的账户下，无需重复添加。", "设备管理"),
}

# 解决方案建议分组，为某一类问题提供通用的解决思路
RECOMMENDATION_GROUP = {
    "配置问题": "请检查您在Home Assistant中的LifeSmart集成配置。",
    "用户授权": "请在“选项”中重新进行认证，或检查您在LifeSmart平台的账户授权。",
    "安全策略": "请检查您在LifeSmart开发者平台的安全设置，如IP白名单。",
    "权限管理": "请联系您的LifeSmart账户管理员调整权限。",
    "服务端错误": "这通常是LifeSmart服务器的临时问题，请稍后重试或联系其技术支持。",
    "网络问题": "请检查您的家庭网络连接以及到互联网的连接。",
    "设备操作": "请检查设备是否在线、固件是否最新，以及操作是否被设备支持。",
    "设备管理": "请在LifeSmart官方App中管理您的设备。",
    "数据校验": "这是一个潜在的集成Bug，请向开发者报告此问题。",
    "方法调用": "这是一个潜在的集成Bug，请向开发者报告此问题。",
    "资源定位": "请检查相关自动化或脚本中引用的设备/场景ID是否正确。",
    "default": "发生未知错误，请查看Home Assistant日志获取详细信息，或联系集成开发者。",
}


def get_error_advice(error_code: int) -> Tuple[str, str, Optional[str]]:
    """根据错误码获取其描述、解决方案和分类。

    Args:
        error_code: 从API返回的数字错误码。

    Returns:
        一个元组，包含：
        - desc (str): 错误的中文描述。
        - advice (str): 针对该错误的具体解决方案建议。
        - category (str | None): 错误的逻辑分类，或None。
    """
    if error_code in ERROR_CODE_MAPPING:
        desc, advice, category = ERROR_CODE_MAPPING[error_code]
        return desc, advice, category

    # 对于未在映射中定义的错误码，动态生成一个通用描述
    error_ranges = {
        (10000, 10100): "API请求或认证错误",
        (10100, 10200): "设备操作或状态错误",
        (20000, 20100): "服务端内部错误",
    }
    desc = next(
        (v for k, v in error_ranges.items() if k[0] <= error_code < k[1]),
        "未知业务错误",
    )
    # 提供一个默认的解决方案建议
    advice = "这是一个未明确定义的错误，请查看日志或联系开发者获取帮助。"
    return desc, advice, None
