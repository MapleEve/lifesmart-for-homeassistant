# LifeSmart集成故障排查指南

本指南帮助您解决LifeSmart Home Assistant集成的常见问题。

## 🚨 快速问题解决

### 第一步：生成诊断数据
在报告任何问题之前，请先生成诊断数据：

1. 进入 **设置** → **设备与服务** → **LifeSmart**
2. 点击 **"下载诊断"** 按钮
3. 保存生成的 `.json` 文件
4. 对于特定设备问题：进入具体设备页面 → 点击 **"下载诊断"**

### 第二步：检查下方常见问题
在创建问题报告之前，请先查看下方的常见问题和解决方案。

---

## 🔌 连接问题

### 云端连接问题
**症状：** 集成连接失败，显示"认证失败"或"API错误"

**解决方案：**
1. **检查凭据：** 验证AppKey、AppToken和UserToken是否正确
2. **区域设置：** 确保选择了正确的区域（中国、北美、欧洲等）
3. **令牌过期：** 令牌可能过期 - 尝试重新认证
4. **网络访问：** 确认Home Assistant能够访问LifeSmart云端服务器

### 本地连接问题  
**症状：** 本地模式连接超时，"无法连接到网关"

**解决方案：**
1. **网络连接：** 验证Home Assistant和LifeSmart网关在同一网络
2. **IP/端口设置：** 确认网关IP地址和端口（通常为8888）
3. **网关状态：** 检查网关是否通电且正常工作
4. **防火墙：** 确保没有防火墙阻止连接

---

## ⚙️ 设备问题

### 设备显示"不可用"
**症状：** 设备出现在HA中但显示"不可用"状态

**常见原因：**
- 设备断电或与网关断开连接
- 设备与网关之间的网络连接问题
- 设备固件问题
- 网关连接问题

**解决方案：**
1. 检查设备电源和网络状态
2. 重启LifeSmart网关
3. 先在LifeSmart应用中重新添加设备
4. 在Home Assistant中重新加载集成

### 设备状态不更新
**症状：** HA中的设备状态与实际设备状态不匹配

**解决方案：**
1. **检查WebSocket连接：** 在诊断数据中验证 `client_status.connected: true`
2. **手动刷新：** 在HA中使用"重新加载集成"
3. **设备排除：** 检查设备是否在排除列表中（集成选项）
4. **网关通信：** 验证设备与网关通信正常

### 设备缺失
**症状：** 某些设备未出现在Home Assistant中

**解决方案：**
1. **排除过滤器：** 检查集成选项中的排除设备/中枢设置
2. **设备兼容性：** 验证设备是否受支持（查看设备规格文档）
3. **网关注册：** 确保设备在LifeSmart应用中正确注册
4. **集成重新加载：** 重新加载集成以重新发现设备

---

## 🚀 性能问题

### 响应缓慢
**症状：** 设备命令执行时间很长

**诊断检查：**
- 查看诊断数据中的 `concurrency_stats`
- 高队列计数表示系统过载

**解决方案：**
1. **减少设备数量：** 考虑排除不必要的设备
2. **网络优化：** 改善网络连接质量
3. **资源分配：** 确保Home Assistant有足够的系统资源

### 内存使用率高
**症状：** Home Assistant占用过多内存

**诊断检查：**
- 查看诊断数据中的 `problematic_devices`
- 设备数量多且出现错误

**解决方案：**
1. **清理问题设备：** 移除或修复导致错误的设备
2. **设备限制：** 考虑减少总设备数量
3. **集成重启：** 重启Home Assistant以清理内存泄漏

---

## 🔧 高级诊断

### 理解诊断数据

诊断文件中需要检查的关键字段：

```json
{
  "hub_info": {
    "device_count": 150,        // 管理的设备总数
    "hub_count": 2,            // LifeSmart网关数量
    "connected": true          // 连接状态
  },
  "client_status": {
    "client_type": "LifeSmartOpenAPIClient",  // 连接类型
    "connected": true                         // 当前连接状态
  },
  "concurrency_stats": {
    "active_operations": 2,    // 当前操作数
    "queue_size": 0           // 待处理操作数
  },
  "problematic_devices": {     // 有问题的设备
    "SL_SW_DM1": {
      "count": 5,             // 错误计数
      "last_seen": "2024-08-10 10:30:15"
    }
  }
}
```

### 性能监控
- **正常运行：** `active_operations` < 10, `queue_size` < 5
- **性能问题：** 队列大小高，活动操作多
- **问题设备：** `problematic_devices` 中的任何条目表示需要注意的设备

---

## 📋 报告问题前

创建GitHub问题时，请：

1. ✅ **附加诊断数据** （集成级别和设备级别，如适用）
2. ✅ **先查看此故障排查指南**
3. ✅ **搜索现有问题** 寻找类似问题
4. ✅ **提供具体详情：**
   - 设备型号和类型
   - 期望行为 vs 实际行为
   - 复现步骤
   - Home Assistant版本
   - 集成版本

---

## 🆘 获取帮助

- **GitHub Issues:** [创建新问题](https://github.com/MapleEve/lifesmart-HACS-for-hass/issues/new/choose)
- **文档：** 查看 `/docs/` 文件夹中的设备规格说明
- **社区：** Home Assistant 中文社区论坛

记住：诊断数据对快速解决问题至关重要！ 📊