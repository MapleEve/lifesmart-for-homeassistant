name: "Upload Release Asset"

on:
  release:
    types: [ published ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Validate version consistency
        run: |
          MANIFEST_VERSION=$(grep '"version"' custom_components/lifesmart/manifest.json | cut -d'"' -f4)
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          echo "Manifest version: $MANIFEST_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch: manifest=$MANIFEST_VERSION, tag=$TAG_VERSION"
            exit 1
          fi
          echo "âœ… Version consistency validated"
          
      - name: Run HACS validation
        uses: hacs/action@main
        with:
          category: integration
          
      - name: Run HassFest validation
        uses: home-assistant/actions/hassfest@master

  build:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create optimized release package
        run: |
          echo "ðŸ—ï¸ Creating optimized release package..."
          mkdir -p release/custom_components
          cp -r custom_components/lifesmart release/custom_components/
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
          echo "ðŸ§¹ Cleaning up unnecessary files..."
          cd release/custom_components/lifesmart
          
          # åˆ é™¤æµ‹è¯•ç›¸å…³æ–‡ä»¶å’Œç›®å½•
          rm -rf tests/
          rm -rf __pycache__/
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + || true
          find . -name "*.pytest_cache" -type d -exec rm -rf {} + || true
          
          # åˆ é™¤å¼€å‘å·¥å…·æ–‡ä»¶
          rm -f .coverage
          rm -f coverage.xml
          rm -f junit-*.xml
          
          echo "ðŸ“¦ Package contents:"
          find . -type f | sort
          
          # åˆ›å»ºzipåŒ…
          cd ../../
          zip -r lifesmart.zip custom_components/lifesmart
          
          echo "âœ… Release package created successfully"
          
      - name: Generate release notes
        run: |
          echo "## ðŸ“‹ ç‰ˆæœ¬æ›´æ–°è¯´æ˜Ž" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ”§ å…¼å®¹æ€§æ”¯æŒ" >> RELEASE_NOTES.md
          echo "- **Home Assistant**: 2023.6.0+" >> RELEASE_NOTES.md
          echo "- **Python**: 3.11 - 3.13" >> RELEASE_NOTES.md
          echo "- **æµ‹è¯•è¦†ç›–**: 4ä¸ªCIçŽ¯å¢ƒå…¨é¢éªŒè¯" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“¦ å®‰è£…è¯´æ˜Ž" >> RELEASE_NOTES.md
          echo "1. ä¸‹è½½ \`lifesmart.zip\`" >> RELEASE_NOTES.md
          echo "2. è§£åŽ‹åˆ° Home Assistant çš„ \`custom_components\` ç›®å½•" >> RELEASE_NOTES.md
          echo "3. é‡å¯ Home Assistant" >> RELEASE_NOTES.md
          echo "4. åœ¨é›†æˆé¡µé¢æ·»åŠ  LifeSmart IoT é›†æˆ" >> RELEASE_NOTES.md

      - name: Upload zip to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: lifesmart.zip
          asset_name: lifesmart.zip
          tag: ${{ github.ref }}
          overwrite: true
          
      - name: Upload release notes
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: RELEASE_NOTES.md
          asset_name: RELEASE_NOTES.md
          tag: ${{ github.ref }}
          overwrite: true