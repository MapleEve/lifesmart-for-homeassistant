# LifeSmart HACS æµ‹è¯•é‡æ„æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº† LifeSmart HACS é¡¹ç›®ä¸­æµ‹è¯•æ¶æ„çš„é‡æ„è¿›å±•ï¼Œæ—¨åœ¨å°†ç¡¬ç¼–ç çš„æµ‹è¯•æ•°æ®æ›¿æ¢ä¸ºåŸºäºå·¥å‚å‡½æ•°å’Œå¤¹å…·çš„å¯ç»´æŠ¤æµ‹è¯•æ¶æ„ã€‚

~~## ğŸ¯ é‡æ„ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™

1. **æ¶ˆé™¤ç¡¬ç¼–ç **ï¼šç§»é™¤æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸­çš„ç¡¬ç¼–ç è®¾å¤‡æ•°æ®
2. **å·¥å‚å‡½æ•°æ¨¡å¼**ï¼šä½¿ç”¨å·¥å‚å‡½æ•°åŠ¨æ€ç”Ÿæˆæµ‹è¯•æ•°æ®
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æµ‹è¯•æ•°æ®åœ¨æ‰€æœ‰å¹³å°é—´ä¿æŒä¸€è‡´
4. **æ˜“äºç»´æŠ¤**ï¼šæµ‹è¯•æ•°æ®é›†ä¸­ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹å’Œæ‰©å±•

### æ¶æ„ä¼˜åŠ¿

- âœ… **å¯ç»´æŠ¤æ€§**ï¼šæµ‹è¯•æ•°æ®é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹ä¸€å¤„å½±å“å…¨å±€
- âœ… **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰å¹³å°ä½¿ç”¨ç»Ÿä¸€çš„æµ‹è¯•æ•°æ®ç”Ÿæˆæ¨¡å¼~~
- âœ… **å¯æ‰©å±•æ€§**ï¼šæ–°å¢è®¾å¤‡ç±»å‹åªéœ€åœ¨å·¥å‚å‡½æ•°ä¸­æ·»åŠ 
- âœ… **é‡ç”¨æ€§**ï¼šå·¥å‚å‡½æ•°å¯åœ¨å¤šä¸ªæµ‹è¯•åœºæ™¯ä¸­é‡ç”¨

## ğŸ“Š é‡æ„è¿›åº¦çŠ¶æ€

### âœ… å·²å®Œæˆçš„å¹³å°æµ‹è¯•æ–‡ä»¶

| å¹³å°                | æ–‡ä»¶è·¯å¾„                                    | çŠ¶æ€       | ä¸»è¦å·¥å‚å‡½æ•°                                                                 | é‡æ„å®Œæˆåº¦ |
|-------------------|-----------------------------------------|----------|------------------------------------------------------------------------|-------|
| **Binary Sensor** | `tests/platforms/test_binary_sensor.py` | âœ… **å®Œæˆ** | `create_devices_by_category()`                                         | 100%  |
| **Climate**       | `tests/platforms/test_climate.py`       | âœ… **å®Œæˆ** | `create_devices_by_category()`, `create_mock_device_climate_fancoil()` | 100%  |
| **Cover**         | `tests/platforms/test_cover.py`         | âœ… **å®Œæˆ** | `create_devices_by_category()`, `create_mock_lifesmart_devices()`      | 100%  |
| **Light**         | `tests/platforms/test_light.py`         | âœ… **å®Œæˆ** | `create_devices_by_category()`, `create_brightness_light_devices()`    | 100%  |
| **Sensor**        | `tests/platforms/test_sensor.py`        | âœ… **å®Œæˆ** | `create_environment_sensor_devices()`, `create_gas_sensor_devices()` ç­‰ | 100%  |
| **Switch**        | `tests/platforms/test_switch.py`        | âœ… **å®Œæˆ** | `create_traditional_switch_devices()`, `create_smart_plug_devices()` ç­‰ | 100%  |

### ğŸ“‚ æ ¸å¿ƒå·¥å‚å‡½æ•°æ¶æ„

#### ä¸»è¦å·¥å‚å‡½æ•°æ–‡ä»¶

- **`tests/utils/factories.py`** - æ ¸å¿ƒå·¥å‚å‡½æ•°é›†åˆ
- **`tests/utils/helpers.py`** - æµ‹è¯•è¾…åŠ©å‡½æ•°
- **`tests/utils/constants.py`** - æµ‹è¯•å¸¸é‡å®šä¹‰

#### é€šç”¨å·¥å‚å‡½æ•°

```python
# ä¸»è¦å·¥å‚å‡½æ•°
create_devices_by_category(category_list)  # æ ¹æ®ç±»åˆ«åˆ›å»ºè®¾å¤‡
create_mock_lifesmart_devices()  # åˆ›å»ºå®Œæ•´è®¾å¤‡é›†åˆ

# ä¸“ç”¨å·¥å‚å‡½æ•°
create_environment_sensor_devices()  # ç¯å¢ƒä¼ æ„Ÿå™¨è®¾å¤‡
create_traditional_switch_devices()  # ä¼ ç»Ÿå¼€å…³è®¾å¤‡
create_brightness_light_devices()  # äº®åº¦ç¯è®¾å¤‡
```

#### è¾…åŠ©å‡½æ•°

```python
# è®¾å¤‡æŸ¥æ‰¾å’ŒéªŒè¯
find_test_device(devices, device_me)  # æŸ¥æ‰¾æµ‹è¯•è®¾å¤‡
find_device_by_friendly_name(devices, friendly_name)  # é€šè¿‡å‹å¥½åç§°æŸ¥æ‰¾
validate_device_data(device)  # éªŒè¯è®¾å¤‡æ•°æ®å®Œæ•´æ€§

# å®ä½“ç®¡ç†
get_entity_unique_id(hass, entity_id)  # è·å–å®ä½“å”¯ä¸€ID
assert_platform_entity_count_matches_devices()  # æ–­è¨€å¹³å°å®ä½“æ•°é‡åŒ¹é…
```

## ğŸ”§ é‡æ„å®æ–½è¦ç‚¹

### 1. æ•°æ®æºè½¬æ¢æ¨¡å¼

**âŒ é‡æ„å‰ï¼ˆç¡¬ç¼–ç ï¼‰ï¼š**

```python
# ä¸æ¨èçš„ç¡¬ç¼–ç æ–¹å¼
device_data = {
    "me": "hardcoded_device_id",
    "agt": "hardcoded_hub_id",
    "data": {"P1": {"val": 123, "type": 1}}
}
```

**âœ… é‡æ„åï¼ˆå·¥å‚å‡½æ•°ï¼‰ï¼š**

```python
# æ¨èçš„å·¥å‚å‡½æ•°æ–¹å¼
devices = create_devices_by_category(["sensor_env", "sensor_quality"])
device = find_test_device(devices, "7d6f")  # åŠ¨æ€æŸ¥æ‰¾
validate_device_data(device)  # æ•°æ®å®Œæ•´æ€§éªŒè¯
```

### 2. æµ‹è¯•è®¾å¤‡æŸ¥æ‰¾æ¨¡å¼

**åŠ¨æ€è®¾å¤‡æŸ¥æ‰¾ï¼š**

```python
# æ ¹æ®è®¾å¤‡ç±»å‹åŠ¨æ€æŸ¥æ‰¾
mock_lifesmart_devices = create_devices_by_category(["binary_sensor"])
device = None
for d in mock_lifesmart_devices:
    if d.get("devtype") == "SL_SC_G":  # é—¨ä¼ æ„Ÿå™¨
        device = d
        break
```

**å‹å¥½åç§°æŸ¥æ‰¾ï¼š**

```python
# é€šè¿‡å‹å¥½åç§°æŸ¥æ‰¾
device = find_device_by_friendly_name(devices, "æ™ºèƒ½é—¨é”")
```

### 3. å®ä½“IDç”Ÿæˆæ¨¡å¼

**åŠ¨æ€å®ä½“IDç”Ÿæˆï¼š**

```python
# åŸºäºè®¾å¤‡æ•°æ®åŠ¨æ€ç”Ÿæˆå®ä½“ID
entity_id = f"sensor.{device['name'].lower().replace(' ', '_')}_t"

# æˆ–ä½¿ç”¨è¾…åŠ©å‡½æ•°
unique_id = generate_unique_id(
    device[DEVICE_TYPE_KEY],
    device[HUB_ID_KEY],
    device[DEVICE_ID_KEY],
    "T"
)
```

## ğŸš€ åç»­å¼€å‘æŒ‡å¯¼

### æ–°å¢æµ‹è¯•æ—¶çš„è¦æ±‚

1. **ç¦ç”¨ç¡¬ç¼–ç **ï¼šä¸¥ç¦åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ç¡¬ç¼–ç è®¾å¤‡æ•°æ®
2. **ä½¿ç”¨å·¥å‚å‡½æ•°**ï¼šå¿…é¡»é€šè¿‡ `create_devices_by_category()` ç­‰å·¥å‚å‡½æ•°è·å–æµ‹è¯•æ•°æ®
3. **åŠ¨æ€æŸ¥æ‰¾è®¾å¤‡**ï¼šä½¿ç”¨ `find_test_device()` æˆ– `find_device_by_friendly_name()` æŸ¥æ‰¾è®¾å¤‡
4. **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨ `validate_device_data()` éªŒè¯è®¾å¤‡æ•°æ®å®Œæ•´æ€§

### æ–°å¢è®¾å¤‡ç±»å‹çš„æ­¥éª¤

1. **åœ¨ `factories.py` ä¸­æ·»åŠ è®¾å¤‡æ•°æ®**
2. **æ›´æ–°ç›¸åº”çš„å·¥å‚å‡½æ•°**
3. **åœ¨ `constants.py` ä¸­æ·»åŠ å‹å¥½åç§°æ˜ å°„**
4. **ç¼–å†™ä½¿ç”¨å·¥å‚å‡½æ•°çš„æµ‹è¯•ç”¨ä¾‹**

### ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹

âœ… **é€šè¿‡æ ‡å‡†ï¼š**

- æµ‹è¯•æ–‡ä»¶ä¸­æ— ç¡¬ç¼–ç è®¾å¤‡æ•°æ®
- ä½¿ç”¨å·¥å‚å‡½æ•°è·å–æµ‹è¯•æ•°æ®
- ä½¿ç”¨è¾…åŠ©å‡½æ•°è¿›è¡Œè®¾å¤‡æŸ¥æ‰¾
- åŒ…å«æ•°æ®å®Œæ•´æ€§éªŒè¯

âŒ **ä¸é€šè¿‡æ ‡å‡†ï¼š**

- åŒ…å«ç¡¬ç¼–ç çš„è®¾å¤‡IDã€Hub IDæˆ–æ•°æ®
- ç›´æ¥æ„é€ è®¾å¤‡å­—å…¸è€Œä¸ä½¿ç”¨å·¥å‚å‡½æ•°
- ç¼ºå°‘è®¾å¤‡æ•°æ®éªŒè¯

## ğŸ“ æŠ€æœ¯å€ºåŠ¡å’Œæ”¹è¿›æœºä¼š

### å·²è¯†åˆ«çš„æŠ€æœ¯å€ºåŠ¡

- æ— ï¼ˆæ‰€æœ‰å¹³å°æµ‹è¯•å·²é‡æ„å®Œæˆï¼‰

### æœªæ¥æ”¹è¿›æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šè€ƒè™‘ç¼“å­˜å·¥å‚å‡½æ•°åˆ›å»ºçš„è®¾å¤‡æ•°æ®
2. **æµ‹è¯•è¦†ç›–åº¦**ï¼šå¢åŠ è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µçš„æµ‹è¯•
3. **æ–‡æ¡£å®Œå–„**ï¼šä¸ºå·¥å‚å‡½æ•°æ·»åŠ æ›´è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜

## ğŸ” è´¨é‡ä¿è¯

### æµ‹è¯•éªŒè¯è¦æ±‚

- æ‰€æœ‰å¹³å°æµ‹è¯•å¿…é¡»é€šè¿‡ CI ç¯å¢ƒéªŒè¯
- æµ‹è¯•æ•°æ®å¿…é¡»é€šè¿‡ `validate_device_data()` éªŒè¯
- æ–°å¢æµ‹è¯•å¿…é¡»éµå¾ªå·¥å‚å‡½æ•°æ¨¡å¼

### æŒç»­é›†æˆæ£€æŸ¥

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
./.testing/test_ci_locally.sh --all

# éªŒè¯ç‰¹å®šå¹³å°
zsh -c "source ~/.zshrc && conda activate ci-test-ha2024.12.0-py3.13 && pytest custom_components/lifesmart/tests/platforms/"
```

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦ååŠ©ï¼Œè¯·ï¼š

1. æŸ¥é˜…æœ¬æ–‡æ¡£çš„ç›¸å…³ç« èŠ‚
2. æ£€æŸ¥ `tests/utils/` ç›®å½•ä¸‹çš„å·¥å‚å‡½æ•°å®ç°
3. å‚è€ƒå·²å®Œæˆçš„å¹³å°æµ‹è¯•æ–‡ä»¶ä½œä¸ºç¤ºä¾‹

**é‡æ„å®Œæˆæ—¶é—´ï¼š** 2025-08-07  
**æœ€åæ›´æ–°ï¼š** 2025-08-07  
**çŠ¶æ€ï¼š** âœ… æ‰€æœ‰å¹³å°æµ‹è¯•é‡æ„å·²å®Œæˆ